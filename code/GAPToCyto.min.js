const letters=[...Array(52).keys()].map(i=>String.fromCharCode(97+i%26+(i<26?0:-32)));var QuiverData,cy,Relations;let mode="default",addingArrow=!1,sourceNodeID=null,autoNameVertexCounter=0,autoNameArrowCounter=1,animationTimer=null;function infLetters(i){var res=letters[i%52];return res+=Array(parseInt(i/52+1)).fill("").reduce((prev,curr)=>prev+"^")}const primes=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61],gens=[1,2,2,3,2,2,3,2,5,2,3,2,6,3,5,2,2,2],pa=msg=>{document.getElementById("outTxtBox").innerHTML=`<span style='color:red; font-size: 20pt'>${msg}</span>`},stripLineBreaksAndSpaces=str=>str.replace(/(\\\r\n|\\\r|\\\n)/,"").replace(/\s+/g,""),matchDeepestBrackets=str=>str.match(/\[([^\[\]])*\]/g);function isPowerOfPrime(x){for(let p of primes){if(x==p)return[p,1];let logp=Math.log(x)/Math.log(p);if(logp%1==0)return[p,logp]}return console.log(`Cannot find ${x} as a power of prime less than 62`),[0,0]}function findFieldChar(str){return"Z"==str[1]?isPowerOfPrime(parseInt(str.slice(3,str.indexOf(")"))))[0]:0}function getCpxNum(str){return-1!=str.indexOf("/")?str:-1!=str.indexOf(".")?str:-1!=str.indexOf("i")?str:-1!=str.indexOf("(")?str.slice(1,-1):str}function translateScalar(a,char){if(-1==char)return a;if(0==char){var res=getCpxNum(a);return"("!=res[0]?"+1"==res||"1"==res?"":"-1"==res?"-":res:res}var hasExpo=a.indexOf("^"),expo=-1!=hasExpo?a.slice(hasExpo+1,-1):1;if(0==expo)return"";var result=Math.pow(gens[primes.indexOf(char)],parseInt(expo));return result==char-1?"-":result}function detectRelation(str){let deepest=matchDeepestBrackets(str),s=str.search(/\[\s*\[/),t=str.search(/\]\s*\]/),m=matchDeepestBrackets(str.slice(s+1,t+str.match(/\]\s*\]/)[0].length-1)).length;return s=deepest.length-m==2?str.search(/\[([^\[\]])*\]\s*$/):str.length,[str.slice(0,s),str.slice(s)]}const positiveCoeffFirst=(x,y)=>x.scalar>0?y.scalar>0?0:-1:1,increasingMonomialLength=(x,y)=>x.monomial.length-y.monomial.length,increasingNumOfTerms=(r1,r2)=>r1.terms.length-r2.terms.length,monomialWithPositiveCoeffFirst=(r1,r2)=>1==r1.terms.length&&1==r2.terms.length?positiveCoeffFirst(r1.terms[0],r2.terms[0]):increasingNumOfTerms(r1,r2);function termsToRelation(terms,joinStr="·"){return terms.reduce((str,t)=>str+t.scalar==""?t.monomial.join(joinStr):"-"==t.scalar?`-${t.monomial.join("·")}`:`${t.scalar}·${t.monomial.join("·")}`,"")}function QPARelationToRelationData(relInputStr,generatorReference,fieldChar){let relData={reln:"",terms:[],fieldChar:fieldChar},terms=relInputStr.split(/\+(?=\()/);for(let i=0;i<terms.length;i++){const match=terms[i].match(/^\((.*?)\)\*(.*)$/);if(!match)throw pa(`Relation string ${relInputStr}, term ${terms[i]} is of invalid format`),new Error("Invalid format in a term of relation");let[scalarRaw,generators]=[match[1],match[2].split("*")];-1==fieldChar&&(relData.fieldChar=findFieldChar(scalarRaw),document.getElementById("controlOutput").innerHTML=`Detected characteristic as ${-1!=relData.fieldChar?relData.fieldChar:"unknown"}.`);const scalar=translateScalar(scalarRaw,relData.fieldChar);let termData={scalar:scalar,monomial:[]},newMono=generators.map(x=>{let q=generatorReference.indexOf(x),arr=-1!=q&&document.getElementById("forceArrow").checked?infLetters(q):x;return termData.monomial.push(arr),arr}).join("·");relData.terms.push(termData);const scalarString=""==scalar?0==i?"":"+":"-"==scalar?"-":`+${scalar}·`;relData.reln+=`${scalarString}${newMono}`}return relData}function translateGraphToQPA(graphData){const nodes=graphData.nodes||[],edges=graphData.edges||[],vxNames=nodes.map(node=>node.data.id),arrStrs=edges.map(edge=>{const{source:source,target:target,label:label}=edge.data;return`["${source}", "${target}", "${label}"]`}),relStrs=Relations?Relations.map(({terms:terms})=>termsToRelation(terms,"*")):[],relations=`[${relStrs.join(", ")}]`;return`Q:=Quiver([${vxNames.map(v=>`"${v}"`).join(", ")}], [${arrStrs.join(", ")}]);\nR:=${relations};`}function transalteQPARelation(relationStr,quiver){const arrows=quiver[1];var arrRef=arrows.map(a=>a[2]);relationStr=""===relationStr?document.getElementById("inRelation").value:relationStr,document.getElementById("inRelation").value=relationStr;var arrRelns=relationStr.replace(/(\\\r\n|\\\r|\\\n)/g,"").replace(/[\s\[\]]/g,"").split(","),charFound=-1,relData=[];for(let rel of arrRelns){let relobj=QPARelationToRelationData(rel,arrRef,charFound);console.log(relobj),relData.push(relobj),charFound=-1==charFound?relobj.fieldChar:charFound}return relData.sort(monomialWithPositiveCoeffFirst),relData}function translateQPA(){var[quiverIn,relationStr]=detectRelation(document.getElementById("inQuiver").value);if("["!=(quiverIn=(quiverIn=(quiverIn=(quiverIn=(quiverIn=(quiverIn=stripLineBreaksAndSpaces(quiverIn)).replace(/(\r\n|\n|\r)/g,"")).replace(/\\/g,"")).replace(/;/g,"")).replace(/^(\s*)Quiver(\(*)/,"")).replace(/\)(\s*)$/,""))[0]){let numVx=parseInt(quiverIn.split(",",1));if(numVx>0){let arrv=Array.from({length:numVx},(_,i)=>i+1);quiverIn=JSON.stringify(arrv)+quiverIn.slice(quiverIn.indexOf(","))}else console.log("not a number before first comma")}quiverIn="["+quiverIn+"]";var quiverQPA=JSON.parse(quiverIn);if(quiverQPA[0].length>70)return pa("More than 70 vertices! Abort translation."),void clearAll();var forceID=document.getElementById("forceID").checked,vxQPA,vx=quiverQPA[0].map((v,i)=>forceID?i+1:`${v}`.replace(/"/g,"")).map(v=>({data:{id:v}})),arrows=quiverQPA[1].map((ar,i)=>{var idlabel=document.getElementById("forceArrow").checked?infLetters(i):ar[2],core;return{data:{id:idlabel,source:forceID?quiverQPA[0].indexOf(ar[0])+1:ar[0],target:forceID?quiverQPA[0].indexOf(ar[1])+1:ar[1],label:idlabel}}});QuiverData={nodes:vx,edges:arrows},Relations=transalteQPARelation(relationStr,quiverQPA),presentData(QuiverData,Relations)}function refreshRelationsOutput(relations){let outputDiv=document.getElementById("relOutput");outputDiv.innerHTML="Relations:<br>";for(let i=0;i<relations.length;i++){let divElt=document.createElement("div");divElt.classList.add("relationRow"),divElt.setAttribute("id",relations[i].reln),divElt.innerHTML=relations[i].reln,divElt.addEventListener("click",()=>{selectNthRelation(i)}),outputDiv.appendChild(divElt)}}function presentData(quiver,relations,isPreset=!1){refreshRelationsOutput(relations),document.getElementById("saveSVG").disabled=!1,document.getElementById("fixCyto").disabled=!1,document.getElementById("wriggle").disabled=!1,document.getElementById("toQPABtn").disabled=!1,cy=initCyto(quiver,isPreset)}function composeCompares(compfuncs,a,b){let c;return range(compfuncs.length).map(i=>compfuncs[i](a[i],b[i])).reduce((accum,curr)=>accum||curr)}function selectNthRelation(n){animationTimer&&(Array.isArray(animationTimer)?animationTimer.forEach(t=>clearInterval(t)):clearInterval(animationTimer),animationTimer=null);let rows=document.querySelectorAll("#relOutput div");for(const e of cy.edges())e.style(coloredEdgeStyle("#000")),e.removeStyle("line-fill line-gradient-stop-colors line-gradient-stop-positions");for(let i=0;i<rows.length;i++)if(i==n){rows[i].classList.add("selectedRelationRow");let color=i%2==0?"#ff6f00":"#0080ff";const pathsToAnimate=[];let allEdges=cy.collection();console.log(Relations[i]);for(const t of Relations[i].terms){const edgesInPath=[];console.log("t: ",t.monomial.join("."));for(const m of t.monomial){let edge=cy.getElementById(m);edgesInPath.push(edge),allEdges=allEdges.union(edge)}pathsToAnimate.push(edgesInPath),console.log("pathsToAnimate length: ",pathsToAnimate.length," | edges added: ",edgesInPath.length)}allEdges.style(coloredEdgeStyle(color)),allEdges.style({"line-fill":"linear-gradient","line-gradient-stop-colors":`${color} ${color} #dafd13 ${color} ${color}`,"line-gradient-stop-positions":"0 0 0 0 0"});let pos=0;console.log("pathsToAnimate: ",pathsToAnimate.map(p=>p.map(e=>e.id()).join(".")).join(" / ")),animationTimer=setInterval(()=>{pos=(pos+2)%200;const t=pos/200,edgeUpdates=new Map;for(const path of pathsToAnimate){const L=path.length;if(0===L)continue;const global_pos=t*L*100;for(let k=0;k<L;k++){const edge=path[k],edgeId=edge.id(),localCenter=global_pos-100*k,isVisible=localCenter>-20&&localCenter<120,dist=Math.abs(localCenter-50),stops=[0,localCenter-15,localCenter,localCenter+15,100].map(p=>Math.max(0,Math.min(100,p))),stopsStr=stops.join(" "),update={dist:dist,stops:stopsStr,isVisible:isVisible};if(edgeUpdates.has(edgeId)){const curr=edgeUpdates.get(edgeId);isVisible&&!curr.isVisible?edgeUpdates.set(edgeId,update):isVisible&&curr.isVisible&&dist<curr.dist&&edgeUpdates.set(edgeId,update)}else edgeUpdates.set(edgeId,update)}}edgeUpdates.forEach((update,edgeId)=>{cy.getElementById(edgeId).style("line-gradient-stop-positions",update.stops)})},60)}else rows[i].classList.remove("selectedRelationRow")}const coloredEdgeStyle=color=>({width:2,"line-color":color,"target-arrow-color":color,"target-arrow-shape":"triangle","curve-style":"bezier","loop-direction":"0deg","loop-sweep":"45deg"});function promptNameAndCheck(msg,cyInstance,type){const autoName=document.getElementById("autoName").checked;let name;if(autoName){let[t,counter]="vertex"===type?["v",autoNameVertexCounter]:["a",autoNameArrowCounter];do{name=`${t}${counter++}`}while(cyInstance&&0!==cyInstance.getElementById(name).length);return name}return name=prompt(msg),name?cyInstance&&0!==cyInstance.getElementById(name).length?(pa("Vertex/Arrow with this name already exists."),null):name:null}function initCyto(inputData,isPreset=!1){let layout=isPreset?{name:"preset",fit:!1}:{name:"breadthfirst",fit:!0,padding:20,nodeDimensionsIncludeLabels:!0},cyInstance=cytoscape({container:document.getElementById("cy"),elements:inputData,style:[{selector:"node",css:{width:25,height:25,shape:"ellipse","background-color":"#ffffff","border-width":"1px","border-style":"solid","border-color":"#000",content:"data(id)","text-valign":"center","text-halign":"center"}},{selector:"node:selected",style:{"background-color":"#fa5252",width:30,height:30}},{selector:"edge",style:coloredEdgeStyle("#000")},{selector:"edge:selected",style:coloredEdgeStyle("#7379f4")},{selector:"edge[label]",style:{label:"data(label)",color:"#ff1818","font-size":"22pt","font-weight":"bold","text-outline-color":"#ee0","text-outline-width":2}}],layout:layout,selectionType:"single",userZoomingEnabled:!0,userPanningEnabled:!0,wheelSensitivity:.5,pan:{x:40,y:40}});return cyInstance.on("tap",ev=>clickOnCanvas(ev,cyInstance)),cyInstance}function clickOnCanvas(ev,cyInstance){var evtTarget=ev.target;if("add"===mode){if(evtTarget===cyInstance){let name=promptNameAndCheck("Enter name for new vertex:",cyInstance,"vertex");name&&cyInstance.add({group:"nodes",data:{id:name},position:ev.position})}else if(evtTarget.isNode())if(addingArrow){let name=promptNameAndCheck("Enter name for new arrow:",cyInstance,"arrow");name&&(cyInstance.add({group:"edges",data:{id:name,source:sourceNodeID,target:evtTarget.id(),label:name}}),addingArrow=!1,sourceNodeID=null,setTimeout(()=>evtTarget.unselect(),50))}else addingArrow=!0,sourceNodeID=evtTarget.id()}else if("delete"===mode){if(evtTarget!==cyInstance){let removedArrows=[];evtTarget.isNode()?removedArrows=evtTarget.connectedEdges().map(e=>e.id()):evtTarget.isEdge()&&(removedArrows=[evtTarget.id()]),cyInstance.remove(evtTarget),removedArrows.length>0&&refreshRelationsOutput(Relations=Relations.filter(rel=>!rel.terms.some(term=>term.monomial.some(m=>removedArrows.includes(m)))))}}else if("rename"===mode&&evtTarget!==cyInstance){let oldId=evtTarget.id(),typeName=evtTarget.isNode()?"vertex":"arrow",newName=promptNameAndCheck(`Enter new name for ${typeName} (current: ${oldId}):`,cyInstance,typeName);if(evtTarget.unselect(),newName)if(evtTarget.isNode()){let edges,edgesJson=evtTarget.connectedEdges().jsons(),nodeJson=evtTarget.json();cyInstance.remove(evtTarget),nodeJson.data.id=newName,cyInstance.add(nodeJson),edgesJson.forEach(edge=>{edge.data.source===oldId&&(edge.data.source=newName),edge.data.target===oldId&&(edge.data.target=newName),cyInstance.add(edge)})}else{let edgeJson=evtTarget.json();cyInstance.remove(evtTarget),edgeJson.data.id=newName,edgeJson.data.label=newName,cyInstance.add(edgeJson);for(let r of Relations){let needUpdate=!1;for(let t of r.terms)for(let i=0;i<t.monomial.length;i++)t.monomial[i]===oldId&&(t.monomial[i]=newName,needUpdate=!0);needUpdate&&(r.reln=termsToRelation(r.terms))}refreshRelationsOutput(Relations)}}}function bendArrow(dir){let edges=cy.$("edge:selected");for(let e of edges){let strCurrDist=e.style("control-point-distance"),dist=0;switch(dir){case"L":dist=-40;break;case"R":dist=40;break;case"S":dist=0}if(console.log(strCurrDist),strCurrDist){let currDist=parseInt(strCurrDist.substring(0,strCurrDist.indexOf("px")));currDist>=0&&dist>0||currDist<=0&&dist<0?e.style("control-point-distance",currDist+dist):e.style("control-point-distance",0),e.style("control-point-weights",.5)}else e.style("control-point-weights",.5),e.style("control-point-distance",dist);1==e.codirectedEdges().length&&e.style("curve-style","unbundled-bezier")}}function clearAll(){document.getElementById("inQuiver").value="",document.getElementById("inRelation").value="",document.getElementById("toQPABtn").disabled=!0,document.getElementById("fixCyto").disabled=!0,document.getElementById("wriggle").disabled=!0,document.getElementById("saveSVG").disabled=!0}function savefile(type){var content,blob,fn;switch(type){case"svg":content=cy.svg({scale:1,full:!0,bg:"#ffffff"}),blob=new Blob([content],{type:"image/svg+xml;charset=utf-8"});break;case"json":content={cy:cy.json(),reln:Relations},console.log(JSON.stringify(content)),blob=new Blob([JSON.stringify(content)],{type:"application/json;charset=utf-8"});break;default:console.log("Invalid filetype")}saveAs(blob,document.getElementById("filenameInput").value+"."+type)}document.getElementById("bendLeft").addEventListener("click",()=>bendArrow("L")),document.getElementById("bendRight").addEventListener("click",()=>bendArrow("R")),document.getElementById("fixCyto").addEventListener("click",()=>cy.fit()),document.getElementById("saveSVG").addEventListener("click",()=>savefile("svg")),document.getElementById("saveJSON").addEventListener("click",()=>savefile("json")),document.getElementById("loadJsonBtn").addEventListener("change",event=>{let reader=new FileReader;reader.addEventListener("load",()=>{let res=JSON.parse(reader.result);presentData(res.cy.elements,res.reln,!0)},!1),reader.readAsText(event.target.files[0])}),document.getElementById("translateBtn").addEventListener("click",()=>translateQPA()),document.querySelectorAll('input[name="editMode"]').forEach(elem=>{elem.addEventListener("change",event=>{mode=event.target.value,cy&&cy.elements().unselect()})}),document.getElementById("btnUnselectRelns").addEventListener("click",()=>selectNthRelation(-1)),document.getElementById("wriggle").addEventListener("click",()=>{cy.layout({name:"cose",animate:!0,animationDuration:1500,randomize:!1,nodeDimensionsIncludeLabels:!0}).run()}),document.getElementById("toQPABtn").addEventListener("click",()=>{const qpaCode=translateGraphToQPA(cy.json().elements);console.log(qpaCode),document.getElementById("outTxtBox").innerHTML=qpaCode}),document.getElementById("cy").addEventListener("click",e=>{if(!cy&&"add"===mode){let name=promptNameAndCheck("Enter name for new vertex:",null,"vertex");name&&(cy=initCyto({nodes:[{data:{id:name},position:{x:e.offsetX-40,y:e.offsetY-40}}],edges:[]},!0)),["toQPABtn","fixCyto","wriggle","saveSVG"].forEach(id=>{document.getElementById(id).disabled=!1})}});